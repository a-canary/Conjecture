[tool:pytest]
# Optimized pytest configuration for Conjecture testing

# Test discovery with intelligent ordering
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Optimized output and reporting
addopts =
    -v
    --tb=short
    --strict-markers
    --disable-warnings
    --color=yes
    --durations=10
    --cov=src
    --cov-report=term-missing
    --cov-report=html:htmlcov
    --cov-report=xml:coverage.xml
    --cov-report=json:coverage.json
    --cov-config=.coveragerc
    -n auto
    --maxfail=5
    --dist=loadscope
    --random-order-bucket=class
    --random-order-seed=42

# Enhanced markers for test optimization
markers =
    unit: Unit tests for individual components (fast)
    integration: Integration tests for component interaction (medium)
    performance: Performance and benchmark tests (slow)
    slow: Tests that take longer to run (>30s)
    asyncio: async test functions
    models: Tests for Pydantic models
    sqlite: SQLite manager specific tests
    chroma: ChromaDB manager specific tests
    embeddings: Embedding service tests
    error_handling: Error handling and edge case tests
    data_manager: DataManager integration tests
    coverage_critical: Tests that cover critical code paths
    coverage_regression: Tests to prevent coverage regression
    coverage_core: Tests for core functionality coverage
    critical: Critical tests for CI/CD pipeline
    utf8: Tests requiring UTF-8 encoding validation
    database_isolation: Tests requiring database isolation
    scientific: Tests requiring scientific validation

# Async support with optimized mode
asyncio_mode = auto

# Test timeout with progressive limits based on test type
timeout = 300
timeout_method = thread

# Parallel execution optimization
# Automatically detect available CPUs but cap at reasonable limit
addopts = --dist=loadscope

# Random test execution for dependency detection
random_order = True
random_order_seed = 42

# Performance testing configuration
benchmark_min_rounds = 3
benchmark_max_time = 60.0
benchmark_timer = time.perf_counter

# Memory and resource limits
faulthandler_timeout = 60

# Coverage optimization
# Exclude patterns for non-critical coverage paths
omit =
    # Test files
    */tests/*
    */test_*
    *_test.py
    tests/*

    # Development and build files
    setup.py
    */setup.py
    */conftest.py

    # Documentation and examples
    docs/*
    examples/*
    demo/*

    # Performance tests (not core functionality)
    */performance_benchmarks*
    */benchmarks/*

    # Generated and cache files
    */__pycache__/*
    */.pytest_cache/*
    */.coverage*

# UTF-8 encoding enforcement
encoding = utf-8
encoding_errors = strict

# Database testing configuration
test_database_isolation = True
test_database_cleanup = True
test_database_pool_size = 1

# Performance reporting
console_output_style = progress
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(name)s: %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

# File output for detailed analysis
log_file = test_optimization.log
log_file_level = DEBUG
log_file_format = %(asctime)s [%(levelname)8s] %(filename)s:%(lineno)d %(funcName)s(): %(message)s
log_file_date_format = %Y-%m-%d %H:%M:%S

# Integration with continuous optimization
# Hook for performance regression detection
# Hook for coverage regression detection
# Hook for flaky test detection

# Minimum version requirements
minversion = 7.0

# Plugin configurations
# pytest-xdist for parallel execution
# pytest-cov for coverage
# pytest-benchmark for performance testing
# pytest-random-order for dependency detection
# pytest-asyncio for async test support
# pytest-timeout for test timeout enforcement
# pytest-mock for advanced mocking capabilities